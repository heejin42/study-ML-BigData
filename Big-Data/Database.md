## 동시성 제어
동시성 제어는 DBMS가 다수의 사용자 사이에서 동시에 실행되는 다중 트랜잭션의 상호간섭 작용에서 데이터베이스를 보호하는 것을 의미한다. 일반적으로 동시성을 허용하면 일관성이 낮아지게 되는데, 일관성을 유지하면서 동시성을 제어할 수 있도록 Lock 기능과 set transaction 명령어로 트랜잭션의 격리 수준을 조정하는 기능이 주로 쓰인다. 그리고 이러한 동시성 제어 방법을 크게 낙관적 동시성 제어와 비관적 동시성 제어로 나눌 수 있다.
- 낙관적 동시성 제어(optimistic concurrency control): 사용자들이 같은 데이터를 동시에 수정하지 않을 것이라고 가정하고 데이터를 수정하는 시점에 값이 변경되었는지 검사한다.
- 비관적 동시성 제어(pessimistic concurrency control): 사용자들이 같은 데이터를 동시에 수정할 것이라고 가정하고 데이터를 읽는 시점에 lock을 걸고, 트랜잭션이 완료될 때까지 이를 유지한다. 하지만 select에 lock을 거는 것이기 때문에 시스템의 동시성을 크게 떨어뜨릴 수 있다. 그래서 주로 wait과 nowait 옵션을 같이 사용한다.

동시성 제어의 목표는 동시에 많은 트랜잭션이 실행될 수 있도록 하면서 입력, 수정, 삭제, 검색 시에 데이터의 무결성을 지키는 것이다. 그래서 동시 업데이트가 잦지 않은 경우라면 낙관적 잠금을 사용한다.   

### Lock
비관성 동시성 제어를 위한 대표적인 방법인 Lock에 대해 더 알아보겠다. 크게 읽기 잠금인 공유락(shared lock)과 쓰기 잠금인 배타락(Exclusive lock)으로 나눌 수 있다. 각각의 동작은 다음과 같다.
- 1번 트랜잭션이 공유락을 가져간 경우: 2번 트랜잭션이 읽으려고 할 때, 데이터가 일관되기 때문에 2번도 또 다른 공유락을 가진다. 2번 트랜잭션이 만약 쓰기를 하려고 할 때, 1번 트랜잭션이 가지고 있는 데이터와 달라질 수 있으므로 1번이 종료될 때까지 기다린다.
- 1번 트랜잭션이 배타락을 가져간 경우: 2번 트랜잭션이 데이터를 읽는 경우, 1번 트랜잭션이 데이터를 변경할 수 있으므로 마칠 때까지 기다린다. 이것은 쓰는 경우도 마찬가지로 작동한다.

또한 획득한 락을 다시 해제하는 방법에는 커밋과 롤백 밖에 없다. 이러한 일반적인 락킹 매커니즘은 여러 문제점을 가지고 있다.
* 읽기 작업과 쓰기 작업이 서로 연관되어 있기 떄문에 동시성 문제가 발생할 수 있다.
* 데이터 일관성에 문제가 생기는 경우도 있어 Lock을 더 오래 유지하거나 테이블 레벨에서의 Lock을 사용해야 한다.

이런 문제를 해결하기 위한 방법이 바로 MVCC(다중 버전 동시성 제어)다.

### MVCC(Muti-Version Concurrency Control, 다중 버전 동시성 제어)
MVCC는 동시 접근을 허용하는 데이터베이스에서 동시성을 제어하기 위해 사용하는 방법 중 하나다. 원본의 데이터와 변경 중인 데이터를 동시에 유지하고, 변경이 완료되면 변경된 데이터를 기록하는 방식으로 Snapshot을 이용한다. 계속해서 데이터의 상태를 백업하는 snapshot이 쌓이기 때문에 사용하지 않는 데이터를 정리하는 시스템이 필요하다. 하지만 잠금을 필요로 하지 않는 특성 상, 일반적인 RDBMS보다 매우 빠르게 작동하게 된다. 